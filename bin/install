#!/usr/bin/env bash
set -e

# check ASDF environment variables
[ -n "$ASDF_INSTALL_VERSION" ] || { echo 'Missing ASDF_INSTALL_VERSION' >&2; exit 1; }
[ -n "$ASDF_INSTALL_PATH" ] || { echo 'Missing ASDF_INSTALL_PATH' >&2; exit 1; }

mkdir -p "${ASDF_INSTALL_PATH}/bin"
toolPath="${ASDF_INSTALL_PATH}/bin/starship"

# Check if download script was used (asdf 0.8.0+)
if [ -n "$ASDF_DOWNLOAD_PATH" ] && [ -f "${ASDF_DOWNLOAD_PATH}/starship.tar.gz" ]; then
  # Use pre-downloaded file
  cd "${ASDF_DOWNLOAD_PATH}"
  tar xzf starship.tar.gz
  mv ./starship "${toolPath}"
else
  # Download and install (fallback for older asdf versions)
  platform="$(uname -s)"
  architecture="$(uname -m)"
  
  case "$platform" in
    "Darwin")
      case "$architecture" in
        "arm64")
          DOWNLOAD_URL="https://github.com/starship/starship/releases/download/v${ASDF_INSTALL_VERSION}/starship-aarch64-apple-darwin.tar.gz"
          ;;
        "x86_64")
          DOWNLOAD_URL="https://github.com/starship/starship/releases/download/v${ASDF_INSTALL_VERSION}/starship-x86_64-apple-darwin.tar.gz"
          ;;
        *)
          echo "Unsupported macOS architecture: $architecture" >&2
          exit 1
          ;;
      esac
      ;;
    "Linux")
      case "$architecture" in
        "armv7l")
          DOWNLOAD_URL="https://github.com/starship/starship/releases/download/v${ASDF_INSTALL_VERSION}/starship-arm-unknown-linux-musleabihf.tar.gz"
          ;;
        "x86_64")
          DOWNLOAD_URL="https://github.com/starship/starship/releases/download/v${ASDF_INSTALL_VERSION}/starship-x86_64-unknown-linux-musl.tar.gz"
          ;;
        "aarch64")
          DOWNLOAD_URL="https://github.com/starship/starship/releases/download/v${ASDF_INSTALL_VERSION}/starship-aarch64-unknown-linux-musl.tar.gz"
          ;;
        *)
          echo "Unsupported Linux architecture: $architecture" >&2
          exit 1
          ;;
      esac
      ;;
    *)
      echo "Unsupported platform: $platform" >&2
      exit 1
      ;;
  esac

  # Verify that DOWNLOAD_URL was set
  [ -n "$DOWNLOAD_URL" ] || { echo 'Failed to determine download URL' >&2; exit 1; }

  # Create temp directory for download
  tmpdir=$(mktemp -d)
  trap 'rm -rf "$tmpdir"' EXIT

  # Download and extract
  curl -fL -o "${tmpdir}/starship.tar.gz" "${DOWNLOAD_URL}"
  cd "${tmpdir}"
  tar xzf starship.tar.gz
  mv ./starship "${toolPath}"
fi

chmod +x "${toolPath}"
